#!/usr/bin/env bash
set -euo pipefail

IFS=$'\n\t'

# Source shared logging library and setup session logging
source "${HOME}/.local/lib/bash-logging.sh"
setup_session_logging "$(basename "$0")"

#/ Usage:
#/   run_after_install-900-setup-status.sh
#/
#/ Description:
#/   Records the setup status after chezmoi apply completes.
#/   Tracks which secrets/config were available during the apply.
#/
#/ Options:
#/   --help:      Display this help message
usage() { grep '^#/' "$0" | cut -c4-; }

readonly STATUS_DIR="${HOME}/.local/state/dotfiles"
readonly STATUS_FILE="${STATUS_DIR}/setup-status"

main() {
  info "▶ Recording dotfiles setup status"

  # Ensure state directory exists
  mkdir -p "$STATUS_DIR"

  # Determine status based on what was available during this chezmoi run
  local has_bws_env="false"
  local has_signing_key="false"

  if [ -n "${BWS_ACCESS_TOKEN:-}" ]; then
    has_bws_env="true"
  fi

  # Check if signingKey was provided (from chezmoi data)
  {{- if ne "" .signingKey }}
  has_signing_key="true"
  {{- end }}

  # Write status file
  cat > "$STATUS_FILE" << EOF
# Dotfiles setup status
# Generated by chezmoi after-install hook
# Last updated: $(date -Iseconds)

has_run_with_bws_env=$has_bws_env
has_run_with_signing_key=$has_signing_key
EOF

  # Show reminder if setup is incomplete
  if [ "$has_bws_env" = "false" ] || [ "$has_signing_key" = "false" ]; then
    echo ""
    warning "╍ Dotfiles applied with incomplete configuration"
    if [ "$has_bws_env" = "false" ]; then
      info "╍ Missing: BWS_ACCESS_TOKEN (for npm auth, GITHUB_TOKEN, etc.)"
    fi
    if [ "$has_signing_key" = "false" ]; then
      info "╍ Missing: signingKey (for git commit signing)"
    fi
    echo ""
    info "╍ Run 'dotfiles-setup' for instructions on completing setup"
  fi
}

main "$@"
