#!/usr/bin/env bash
set -euo pipefail

IFS=$'\n\t'

# Normalize TMPDIR (strip trailing slash for consistent path construction)
TMPDIR="${TMPDIR:-/tmp}"
TMPDIR="${TMPDIR%/}"

# Source shared logging library and setup session logging
source "${HOME}/.local/lib/bash-logging.sh"
setup_session_logging "$(basename "$0")"

#/ Usage:
#/   run_after_install-900-setup-status.sh
#/
#/ Description:
#/   Records the setup status after chezmoi apply completes.
#/   Tracks which secrets/config were available during any apply.
#/   State rolls forward: once a capability is unlocked, it stays unlocked.
#/
#/ Options:
#/   --help:      Display this help message
usage() { grep '^#/' "$0" | cut -c4-; }

readonly STATE_DIR="${HOME}/.local/state/dotfiles"
readonly STATE_FILE="${STATE_DIR}/chezmoi-state.boltdb"
readonly STATE_BUCKET="dotfiles"
readonly KEY_BWS="has_bws_env"
readonly KEY_SIGNING="has_signing_key"

get_state() {
  local key="$1"
  local value
  # Use separate state file to avoid lock contention with parent chezmoi process
  value=$(chezmoi state get --persistent-state "$STATE_FILE" --bucket "$STATE_BUCKET" --key "$key" 2>/dev/null || echo "")
  # Default to "false" if empty or missing
  if [ -z "$value" ]; then
    echo "false"
  else
    echo "$value"
  fi
}

set_state() {
  local key="$1"
  local value="$2"
  mkdir -p "$STATE_DIR"
  chezmoi state set --persistent-state "$STATE_FILE" --bucket "$STATE_BUCKET" --key "$key" --value "$value"
}

main() {
  info "▶ Recording dotfiles setup status"

  # Read previous state (rolls forward - once true, stays true)
  local has_bws_env
  local has_signing_key
  has_bws_env=$(get_state "$KEY_BWS")
  has_signing_key=$(get_state "$KEY_SIGNING")

  # Update state if current run has capabilities
  # Check for age identity file
  if [ -f "{{ .ageIdentityPath }}" ]; then
    has_bws_env="true"
  fi

  {{- if ne "" .signingKey }}
  has_signing_key="true"
  {{- end }}

  # Persist state
  set_state "$KEY_BWS" "$has_bws_env"
  set_state "$KEY_SIGNING" "$has_signing_key"

  # Show reminder if setup has never been completed
  if [ "$has_bws_env" = "false" ] || [ "$has_signing_key" = "false" ]; then
    echo ""
    warning "╍ Dotfiles setup incomplete"
    if [ "$has_bws_env" = "false" ]; then
      info "╍ Missing: age identity (for npm auth, GITHUB_TOKEN, etc.)"
    fi
    if [ "$has_signing_key" = "false" ]; then
      info "╍ Missing: signingKey (for git commit signing)"
    fi
    echo ""
    info "╍ Run 'dotfiles-setup' for instructions on completing setup"
  fi
}

main "$@"
