#!/usr/bin/env bash
set -euo pipefail

IFS=$'\n\t'

# Source shared logging library and setup session logging
source "${HOME}/.local/lib/bash-logging.sh"
setup_session_logging "$(basename "$0")"

#/ Usage:
#/   change-term.sh
#/
#/ Description:
#/   Sets the shell for the user.
#/
#/ Options:
#/   --help:      Display this help message
usage() { grep '^#/' "$0" | cut -c4-; }

main() {
  info "▶ Setting the user shell to zsh"

  zsh_shell="$(which zsh)"
  info "╍  \$SHELL    = ${SHELL}"
  info "╍  which zsh = ${zsh_shell}"
  if [ "$SHELL" = "$zsh_shell" ]; then
    info "╍ User shell already set"
    return
  fi

  if [[ ! $(command -v zsh) ]]; then
    fatal "You must manually install zsh and set it as the default shell.\n 1. Install \"zsh\"\n 2. Run: chsh -s \"$zsh_shell\""
  fi

  # In Coder devbox, skip /etc/shells and sudo
  if [[ -n "${CODER:-}" ]]; then
    info "╍ Coder detected, skipping /etc/shells modification"
    info "╍ Running 'chsh' to change shell to: ${zsh_shell}"
    chsh -s "$zsh_shell"
    info "╍ Now, run 'zsh' to start a new term session"
    return
  fi

  if [ "$(id -u)" = "0" ]; then
    Sudo=''
    info "╍ Root user detected, skipping sudo for following commands"
  elif which sudo >/dev/null 2>&1; then
    Sudo='sudo'
    info "╍ Sudo detected, using it for following commands"
  else
    Sudo=''
    warning "╍ Cannot find 'sudo' so will attempt to run following commands without it"
  fi

  # Check if the zsh_shell exists in /etc/shells, if not just append it in
  if ! grep -q "^${zsh_shell}$" /etc/shells; then
    info "╍ Adding ${zsh_shell} to /etc/shells"
    echo "$zsh_shell" | $Sudo tee -a /etc/shells >/dev/null
  else
    info "╍ ${zsh_shell} exists in /etc/shells"
  fi

  # Change the default shell to zsh, if it isn't already the default
  info "╍ Running 'chsh' to change shell to: ${zsh_shell}"
  chsh -s "$zsh_shell" "$(whoami)"

  info "╍ Now, run 'zsh' to start a new term session"
}

main "$@"
