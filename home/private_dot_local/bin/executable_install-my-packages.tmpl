#!/bin/sh

set -o errexit
set -o nounset

#/ Usage:
#/   my-install-packages [options]
#/   my-install-packages --gui
#/
#/ Description:
#/
#/ Options:
#/   --gui: Optional. Install GUI app packages in addition to CLI packages.
#/   --help: Display this help message
usage() { grep '^#/' "$0" | cut -c4- ; }

gui=1

while [ $# -gt 0 ]; do
  case "$1" in
    --help)
      usage
      exit 0
      ;;
    --gui)
      gui=0
      ;;
    *)
      echo "Invalid argument: $1"
      usage
      exit 1
  esac
  shift
done

main() {
  mise install

  #
  #-----------------------------------------------------------------------------
  # Macos-only
  #-----------------------------------------------------------------------------
  #

  {{ if eq .chezmoi.os "darwin" }}

  PATH="$PATH:{{ .brewprefix }}/bin"

  {{ $brews := list
       "bash"
       "coreutils"
       "ffmpeg"
       "git"
       "git-lfs"
       "gnupg"
       "handbrake"
       "htop"
       "less"
       "lua"
       "make"
       "ncdu"
       "ncurses"
       "pinentry"
       "pinentry-mac"
       "readline"
       "rename"
       "safe-rm"
       "shellcheck"
       "tmux"
       "tree"
       "wget"
       "wireguard-tools"
       "zsh" -}}
  {{ $casks := list
       "alfred"
       "bartender"
       "brave-browser"
       "docker"
       "figma"
       "finicky"
       "firefox"
       "fontgoggles"
       "glyphs"
       "google-chrome"
       "imageoptim"
       "insomnia"
       "iterm2"
       "jetbrains-toolbox"
       "kap"
       "logitune"
       "notion"
       "private-internet-access"
       "qlcolorcode"
       "qlimagesize"
       "qlmarkdown"
       "qlvideo"
       "quicklookase"
       "rectangle"
       "rive"
       "rocket"
       "slack"
       "spotify"
       "sublime-text"
       "visual-studio-code"
       "vlc" -}}
  {{ $goget := list
       "github.com/CtrlSpice/otel-desktop-viewer@latest"
       "github.com/equinix-labs/otel-cli@latest" -}}

  if ! command -v brew > /dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  fi

  # Brew managed programs/libraries
  brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range ($brews | sortAlpha | uniq) -}}
brew {{ . | quote }}
{{ end -}}
EOF

  # Brew managed GUI
  if [ $gui -eq 0 ]; then
    brew bundle --no-lock --file=/dev/stdin <<EOF
{{ range ($casks | sortAlpha | uniq) -}}
cask {{ . | quote }}
{{ end -}}
EOF
  fi

  # Go built binaries
  {{ range ($goget | sortAlpha | uniq) -}}
  {{ $.brewprefix }}/bin/go install {{ . | quote }}
  {{ end -}}

  #
  #-----------------------------------------------------------------------------
  # Linux-only
  #-----------------------------------------------------------------------------
  #

  {{ else if eq .chezmoi.os "linux" -}}
    {{ $pkgs := list
    "bash"
    "coreutils"
    "ffmpeg"
    "git"
    "git-lfs"
    "gnupg"
    "less"
    "make"
    "rename"
    "safe-rm"
    "tree"
    "wget"
    "zsh" -}}

    packages=$(cat <<EOF
{{ range ($pkgs | sortAlpha | uniq) -}}
  {{ . | quote }}
{{ end -}}
EOF
)

    linux_distro="{{ .chezmoi.osRelease.id }}"
    # TODO finish this, copy over from install.sh
    case $linux_distro in
      alpine)
        info " ▶ Running 'apk add git zsh'"
        $Sudo apk add --update --no-cache git curl zsh
      ;;
      amzn|rhel|fedora|rocky)
        info " ▶ Running 'yum install git zsh'"
        $Sudo yum update -y
        $Sudo yum install -y git zsh
      ;;
      *)
        info " ▶ Running 'apt-get install git zsh locales'"
        $Sudo apt-get update
        $Sudo apt-get -y install git curl zsh locales
        #if [ "$VERSION" != "14.04" ]; then
        #  $Sudo apt-get -y install locales-all
        #fi
        info " ▶ Running 'locale-gen en_US.UTF-8'"
        $Sudo locale-gen en_US.UTF-8
    esac
    {{ if eq .chezmoi.osRelease.id "ubuntu" -}}
    sudo apt update
    sudo apt install -y $(echo "$packages" | xargs)
    {{ #Golang template for checking multiple versions -}}
    {{
    {{ else if eq .chezmoi.osRelease.id "fedora" -}}
    sudo yum install -y $(echo "$packages" | xargs)
    {{ else if eq .chezmoi.osRelease.id "alpine" -}}
    sudo apk add $(echo "$packages" | xargs)
    {{ else }}
    echo "Not implemented for this Linux OS: {{ .chezmoi.os }} / {{ .chezmoi.osRelease.id }}"
    echo "Full release details from /etc/os-release:"
    cat /etc/os-release
    {{ end }}

  #
  #-----------------------------------------------------------------------------
  # Unsupported OS
  #-----------------------------------------------------------------------------
  #

  {{ else }}
  echo "Not implemented for this OS: {{ .chezmoi.os }}"

  {{ end }}
}

main "${@:-""}"
