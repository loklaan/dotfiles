#!/usr/bin/env bash
set -euo pipefail

IFS=$'\n\t'

# Normalize TMPDIR (strip trailing slash for consistent path construction)
TMPDIR="${TMPDIR:-/tmp}"
TMPDIR="${TMPDIR%/}"

# Source shared logging library and setup session logging
source "${HOME}/.local/lib/bash-logging.sh"
setup_session_logging "$(basename "$0")"

#/ Usage:
#/   dotfiles-setup [OPTIONS]
#/
#/ Description:
#/   Checks dotfiles configuration status and provides instructions for
#/   completing setup. Run this after initial dotfiles installation.
#/
#/ Options:
#/   --help:      Display this help message
usage() { grep '^#/' "$0" | cut -c4-; }

readonly STATE_DIR="${HOME}/.local/state/dotfiles"
readonly STATE_FILE="${STATE_DIR}/chezmoi-state.boltdb"
readonly STATE_BUCKET="dotfiles"
readonly KEY_BWS="has_bws_env"
readonly KEY_SIGNING="has_signing_key"

parse_args() {
  while [ "$#" -gt 0 ]; do
    case "$1" in
      --help)
        usage
        exit 0
        ;;
      *)
        usage
        fatal "Unknown argument: $1"
        ;;
    esac
  done
}

get_state() {
  local key="$1"
  local value
  value=$(chezmoi state get --persistent-state "$STATE_FILE" --bucket "$STATE_BUCKET" --key "$key" 2>/dev/null || echo "")
  if [ -z "$value" ]; then
    echo "false"
  else
    echo "$value"
  fi
}

read_status() {
  has_bws_env=$(get_state "$KEY_BWS")
  has_signing_key=$(get_state "$KEY_SIGNING")
}

print_status() {
  info "▶ Dotfiles Configuration Status"
  echo ""

  if [ "$has_bws_env" = "true" ]; then
    _print green "  ✓ BWS encrypted token: applied"
    _print white dim "    npm auth token, GITHUB_TOKEN, pr-train configured"
  else
    _print yellow "  ✗ BWS encrypted token: not applied"
    _print white dim "    Missing: npm auth token, GITHUB_TOKEN, pr-train"
  fi

  if [ "$has_signing_key" = "true" ]; then
    _print green "  ✓ signingKey: applied"
  else
    _print yellow "  ✗ signingKey: not applied"
    _print white dim "    Git commit signing disabled"
  fi

  echo ""
}

print_instructions() {
  local missing_bws="$1"
  local missing_key="$2"

  if [ "$missing_bws" = "false" ] && [ "$missing_key" = "false" ]; then
    info "▶ All configuration complete!"
    return
  fi

  _print cyan bold "To complete setup:"
  echo ""

  if [ "$missing_bws" = "true" ]; then
    echo "1. Get your BWS access token from Bitwarden Secrets Manager:"
    echo "   https://vault.bitwarden.com → Secrets Manager → Machine accounts"
    echo ""
    echo "   The token will be encrypted and stored at:"
    echo "   ~/.config/chezmoi/secrets/bws-access-token.gpg"
    echo ""
  fi

  if [ "$missing_key" = "true" ]; then
    echo "2. Get your signing key:"
    echo "   GPG: Run 'gpg -K --keyid-format SHORT' to list keys"
    echo "   SSH: Use path like '~/.ssh/id_ed25519.pub'"
    echo ""
  fi

  echo "Then re-run install.sh (you'll be prompted for missing values):"
  echo ""

  # Build the command
  local cmd="  \$HOME/.local/share/chezmoi/install.sh"
  _print red "$cmd"
  echo ""

  if [ "$missing_bws" = "true" ]; then
    echo "Or provide values via environment variables:"
    echo ""
    local env_cmd="  CONFIG_ENCRYPTION_PASSPHRASE=<passphrase> CONFIG_BWS_ACCESS_TOKEN=<token>"
    if [ "$missing_key" = "true" ]; then
      env_cmd+=" CONFIG_SIGNING_KEY=<key>"
    fi
    env_cmd+=" \$HOME/.local/share/chezmoi/install.sh"
    _print white dim "$env_cmd"
    echo ""
  fi

  info "╍ This will re-apply all dotfiles with secrets populated"
}

main() {
  parse_args "$@"

  if [ ! -f "$STATE_FILE" ]; then
    warning "State file not found: $STATE_FILE"
    info "╍ Run 'chezmoi apply' first to generate status"
    exit 1
  fi

  read_status
  print_status

  local missing_bws="false"
  local missing_key="false"

  if [ "$has_bws_env" = "false" ]; then
    missing_bws="true"
  fi
  if [ "$has_signing_key" = "false" ]; then
    missing_key="true"
  fi

  print_instructions "$missing_bws" "$missing_key"
}

main "$@"
