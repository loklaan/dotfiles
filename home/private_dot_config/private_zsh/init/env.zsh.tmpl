#|-----------------------------------------------------------------------------|
#| INIT MODULE: Environment                                                    |
#|-----------------------------------------------------------------------------|
#|
#| Purpose:
#|   This module establishes the foundational environment configuration for all
#|   shell sessions (login, non-login, interactive, non-interactive). It sets
#|   up critical environment variables and constructs the $PATH with a specific
#|   order of precedence to ensure correct executable resolution across both
#|   Linux distributions and macOS (primary OS).
#|
#| Responsibilities:
#|   - Locale and language settings (UTF-8)
#|   - User and editor preferences
#|   - XDG Base Directory specification compliance
#|   - System resource limits (file descriptors)
#|   - Platform-specific configurations (WSL display, Homebrew paths)
#|   - Service authentication tokens (GitHub, etc.)
#|   - Language toolchain SDKs (Android, Playdate, Node.js, etc.)
#|   - User aliases integration
#|
#| $PATH Order of Precedence (left to right search):
#|   1. Context/Project Specific (most specific)
#|      - Currently prepended by tools like mise shims, direnv, etc.
#|      - Allows project-level overrides of all other tools, e.g. node_modules/.bin
#|
#|   2. User Custom / Local Binaries
#|      - $HOME/.local/bin
#|      - User-installed scripts and binaries
#|
#|   3. Version Managers
#|      - Mise shims (activated separately in login.zsh for full mode)
#|      - Language-specific version managers (pyenv, cargo, etc.)
#|
#|   4. System Local
#|      - /usr/local/sbin, /usr/local/bin
#|      - Package manager binaries (Homebrew on macOS)
#|      - Locally compiled/installed system software
#|
#|   5. System Default (core utilities)
#|      - /usr/bin, /bin, /usr/sbin, /sbin
#|      - Essential system binaries and commands
#|
#|   6. Application SDKs (least specific)
#|      - Language toolchains: $ANDROID_HOME, $PLAYDATE_SDK_PATH, etc.
#|      - Specialized development tools: $FLYCTL_INSTALL, etc.
#|      - Appended to ensure they don't override system or user tools
#|
#| Note: The shell searches $PATH left to right, so earlier entries take
#|       precedence. This ordering ensures that user and project-specific
#|       tools override system defaults while maintaining system stability.
#|
#|-----------------------------------------------------------------------------|

#|------------------------------------------------------------|#
#| Locale
#|
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8
export LANGUAGE=en_US.UTF-8

#|------------------------------------------------------------|#
#| User
#|
export DEFAULT_USER=loch
export EDITOR='idea --wait'

#|------------------------------------------------------------|#
#| XDG
#|
export XDG_CACHE_HOME="$HOME/Library/Caches"
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.local/share"

#|------------------------------------------------------------|#
#| Filesystem Performance
#|
ulimit -n 10240 # Raises the limit for open files, which is important for large git repos
bgnotify_threshold=8

#|------------------------------------------------------------|#
#| WSL
#|
{{ if eq .chezmoi.os "linux" -}}
{{   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") -}}
# VcxSrv Display (WSL hosted UIs)
export DISPLAY=${DISPLAY:-$(grep -Po '(?<=nameserver ).*' /etc/resolv.conf):0}
{{   end -}}
{{- end }}

#|------------------------------------------------------------|#
#| Service Tokens
#|  - Github
#|  - LLMs
#|
export GITHUB_TOKEN={{ (bitwardenSecrets "13a3305b-0c71-411c-89e3-b37c016033b5").value }}

{{ if eq .chezmoi.os "darwin" -}}
#|------------------------------------------------------------|#
#| Package Manager Settings
#|  - Homebrew
#|
export HOMEBREW_GITHUB_API_TOKEN=$GITHUB_TOKEN
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_EMOJI=1
export HOMEBREW_NO_INSECURE_REDIRECT=1
{{- end }}

{{ if ne "" .emailWork -}}
# Canva-only
export JETBRAINS_LICENSE_SERVER=https://canva.fls.jetbrains.com/
{{- end }}

#|------------------------------------------------------------|#
#| Base Pathing
#|
#|  PATH precedence (left â†’ right for executables):
#|   1) Context/Project specific (injected by tools like direnv/mise later)
#|   2) User local binaries
#|   3) System local (incl. Homebrew on macOS)
#|   4) System defaults
#|   5) Previous PATH (lowest, so earlier context-specific injectors can re-prepend as needed)
#|
{{ $pkg_manager_path := "" -}}
{{ if eq .chezmoi.os "darwin" -}}
{{   $pkg_manager_path = (printf ":%s/bin:%s/sbin" .brewprefix .brewprefix) -}}
{{- end }}
export PATH="$HOME/.local/bin{{$pkg_manager_path}}:/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin:$PATH"
#| Mise (shim)
eval "$(mise activate zsh --shims)"
#| Language/tool chains
#|  Android
export ANDROID_HOME="$HOME/Library/Android/sdk"
export PATH="$PATH:$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools"
#|  Playbook
export PLAYDATE_SDK_PATH="$HOME/Developer/PlaydateSDK"
export PATH="$PATH:$PLAYDATE_SDK_PATH/bin"
#|  Fly.io
export FLYCTL_INSTALL="$HOME/.fly"
export PATH="$PATH:$FLYCTL_INSTALL/bin"
#|  Nodejs
export NODE_MAX_OLD_SPACE_SIZE=8192
export PNPM_HOME="$HOME/.local/share/pnpm"

#|------------------------------------------------------------|#
#| Aliases
#|
if [[ -f "${HOME}/.aliases" ]]; then
  # shellcheck source=home/dot_aliases
  source "${HOME}/.aliases"
fi
source "$ZSH_CONFIG_DIR/lib/aliases.zsh"
