#|-----------------------------------------------------------------------------|
#| INIT MODULE: Login                                                          |
#|-----------------------------------------------------------------------------|
#|                                                                             |
#| Purpose:                                                                    |
#|   Configures the shell environment for login shells, including package      |
#|   managers, background services, development tools, and optional tmux       |
#|   session management.                                                       |
#|                                                                             |
#| Responsibilities:                                                           |
#|   - Activate package managers (mise, nix)                                   |
#|   - Start background daemons (ssh-agent, GPG)                               |
#|   - Initialize development environment (coder boxes)                        |
#|   - Configure tmux session management                                       |
#|                                                                             |
#|-----------------------------------------------------------------------------|

#|------------------------------------------------------------|#
#| Package Managers
#|  - Mise (full)
#|  - Nix
#|
source "${HOME}/.local/lib/term.zsh"
if is_interactive_shell && command -v mise &> /dev/null; then
  eval "$(mise activate zsh)"
fi
[[ ! $(command -v nix) && -e "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]] && source "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"

#|------------------------------------------------------------|#
#| Background Daemons / Agents
#|  - SSH
#|
source "${HOME}/.local/lib/ssh.sh"
if typeset -f _ssh_agent > /dev/null; then
  _ssh_agent
fi
export GPG_TTY=$(tty)

#|------------------------------------------------------------|#
#| Dev Machines & LLM Agents
#|  - Coder boxes
#|
[ -e "$HOME/.coder.sh" ] && . "$HOME/.coder.sh"

#|------------------------------------------------------------|#
#| Dotfiles Setup Reminder
#|
#| Shows a reminder if secrets were not applied during chezmoi install.
#|
_dotfiles_status_file="$HOME/.local/state/dotfiles/setup-status"
if [[ -f "$_dotfiles_status_file" ]]; then
  _has_bws=$(grep '^has_run_with_bws_env=' "$_dotfiles_status_file" 2>/dev/null | cut -d= -f2)
  _has_key=$(grep '^has_run_with_signing_key=' "$_dotfiles_status_file" 2>/dev/null | cut -d= -f2)
  if [[ "$_has_bws" != "true" || "$_has_key" != "true" ]]; then
    echo ""
    print -P "%F{yellow}Dotfiles applied with incomplete configuration.%f"
    print -P "Run %F{cyan}dotfiles-setup%f for instructions."
    echo ""
  fi
  unset _has_bws _has_key
fi
unset _dotfiles_status_file
