#|-----------------------------------------------------------------------------|
#| INIT MODULE: Login                                                          |
#|-----------------------------------------------------------------------------|
#|                                                                             |
#| Purpose:                                                                    |
#|   Configures the shell environment for login shells, including package      |
#|   managers, background services, development tools, and optional tmux       |
#|   session management.                                                       |
#|                                                                             |
#| Responsibilities:                                                           |
#|   - Activate package managers (mise, nix)                                   |
#|   - Start background daemons (ssh-agent, GPG)                               |
#|   - Initialize development environment (coder boxes)                        |
#|   - Configure tmux session management                                       |
#|                                                                             |
#|-----------------------------------------------------------------------------|

#|------------------------------------------------------------|#
#| Package Managers
#|  - Mise (full)
#|  - Nix
#|
source "${HOME}/.local/lib/term.zsh"
if is_interactive_shell && command -v mise &> /dev/null; then
  # Remove shims from path before full activation to avoid conflict
  path=(${path:#$HOME/.local/share/mise/shims})
  eval "$(mise activate zsh)"
fi
[[ ! $(command -v nix) && -e "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]] && source "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"

#|------------------------------------------------------------|#
#| Background Daemons / Agents
#|  - SSH
#|
source "${HOME}/.local/lib/ssh.sh"
if typeset -f _ssh_agent > /dev/null; then
  _ssh_agent
fi
export GPG_TTY=$(tty)

#|------------------------------------------------------------|#
#| Dev Machines & LLM Agents
#|  - Coder boxes
#|
[ -e "$HOME/.coder.sh" ] && . "$HOME/.coder.sh"

#|------------------------------------------------------------|#
#| Dotfiles Setup Reminder
#|
#| Shows a reminder if secrets were not applied during chezmoi install.
#|
_incomplete_setup=false

# Check for BWS token file
if [[ ! -f "{{ .bwsTokenPath }}" ]]; then
  _incomplete_setup=true
fi

# Check for signing key
{{- if eq "" .signingKey }}
_incomplete_setup=true
{{- end }}

if [[ "$_incomplete_setup" == "true" ]]; then
  echo ""
  print -P "%F{yellow}Dotfiles applied with incomplete configuration.%f"
  print -P "Run %F{cyan}dotfiles-setup%f for instructions."
  echo ""
fi
unset _incomplete_setup
